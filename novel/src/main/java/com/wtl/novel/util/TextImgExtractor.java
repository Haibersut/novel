package com.wtl.novel.util;

import java.util.*;
import java.util.regex.*;

public class TextImgExtractor {

    /** 返回结果封装 */
    public static class Result {
        public final String textNoImg;                    // 去空行、去<img>后的文本
        public final Map<String, String> imgWithPos;     // <img标签, 行号_总行数>，保证顺序
        Result(String textNoImg, Map<String, String> imgWithPos) {
            this.textNoImg = textNoImg;
            this.imgWithPos = imgWithPos;
        }
    }

    /** 唯一入口 */
    public static Result process(String raw) {
        String[] lines = raw.split("\\r?\\n");

        StringBuilder sb = new StringBuilder();
        Map<String, String> imgMap = new LinkedHashMap<>(); // 保证顺序

        int lineNo = 0;
        Pattern imgPattern = Pattern.compile("<img\\b[^>]*>", Pattern.CASE_INSENSITIVE);

        for (String rawLine : lines) {
            String line = rawLine.trim();
            if (line.isEmpty()) continue;

            lineNo++;
            Matcher m = imgPattern.matcher(line);
            while (m.find()) {
                String img = m.group();
                imgMap.put(img, lineNo + "_");   // 后面再补总行数
            }
            String clean = imgPattern.matcher(line).replaceAll("");
            if (!clean.isEmpty()) {
                sb.append(clean).append('\n');
            }
        }

        int total = lineNo;
        // 补全“_总行数”
        imgMap.replaceAll((k, v) -> v + total);

        return new Result(sb.toString(), imgMap);
    }

    /* ------ 测试 ------ */
    public static void main(String[] args) {
        String src = "‘...뜨,뜨거웟?!♥..그리고..커어엇!?!♥♥’\n" +
                " \n" +
                "\n" +
                "보지가 쑤셔지는 순간 이벨린의 머릿속을 스친 생각이었다.\n" +
                " \n" +
                "\n" +
                "뭐, 이안의 자지야 평소에도 평범한 자지와는 비교를 거부하는 거근이었지만 지금은 뭔가 달랐다.\n" +
                " \n" +
                "\n" +
                "‘머..머얏..!♥이거엇..?!자...잠깐...♥끄흐으흑!!♥...으옥!♥...이..이거...♥...펴..평소랑..!..달랏..!♥♥’\n" +
                " \n" +
                "\n" +
                "오랜만에 하는 섹스라서 그런 것일까?\n" +
                " \n" +
                "\n" +
                "잠깐 그런 생각이 들었지만, 그건 아닌 것 같았다.\n" +
                " \n" +
                "\n" +
                "이안이 이벨린의 보지를 평가할 때 ‘전용 보지’라고 평가하는 것처럼, 이벨린에게 있어 이안의 자지는 ‘전용 자지’였다.\n" +
                " \n" +
                "\n" +
                "마치 서로와 교미하기 위해서 태어난 것처럼 ‘완벽한 속궁합’을 자랑하는 ‘전용 성기’들은 ‘언제’, ‘어디’에서 섹스하더라도 두 사람에게 최고의 쾌감을 선사했다.\n" +
                " \n" +
                "\n" +
                "즉, 고작해야 몇 주 동안 섹스하지 않았다고 해서 그 ‘완벽한 속궁합’이 사라지지는 않는다는 뜻이다.\n" +
                " \n" +
                "\n" +
                "퍼억-! 퍼억-!\n" +
                " \n" +
                "\n" +
                "“힉!..♥으흑!.....♥흑.!...으끄흐!..,이..이안...♥..흐에앗!♥...아.!...흐!!..흐끄아!..하읏!!♥”\n" +
                " \n" +
                "\n" +
                "...그렇다면 지금 이벨린이 느끼는 이질감은 왜 발생했는가?\n" +
                " \n" +
                "\n" +
                "“히이익!!..이...이안!...흐!♥...옥...으우헷!!!♥...자...자깜..!..♥..머..멈쪄..♥..멈..쪄봣!!♥..머..먼가..끅!?...이샹하..곳!!♥...끄히에!♥”\n" +
                " \n" +
                "\n" +
                "정답은 의외로 단순했다.\n" +
                " \n" +
                "\n" +
                "「흥분」\n" +
                " \n" +
                "\n" +
                "\n" +
                "‘임신 위험일’에 노콘 섹스를 한다는 엄청난 ‘흥분’이 이안의 신체 변화를 일으켰기 때문이었다.\n" +
                " \n" +
                "\n" +
                "당연히 지금까지 잔뜩 섹스 한 만큼 위험일 노콘 섹스도 처음은 아니었다.\n" +
                " \n" +
                "\n" +
                "이전에도 몇 번이나 이안과 이벨린은 위험일에 노콘 질싸를 즐겼으니까.\n" +
                " \n" +
                "\n" +
                "“후끅!.♥..끄헤...!♥...!!♥흐아..!!♥아...안대!..이..이안!♥...끄히..머!♥..머,멈쪄봣!♥”\n" +
                " \n" +
                "\n" +
                "그러나 그건 어디까지나 ‘피임 포션’을 준비한 상태에서 한 계획 된 섹스였다.\n" +
                " \n" +
                "\n" +
                "...하지만 지금은?\n" +
                " \n" +
                "\n" +
                "이벨린은 절대로 ‘피임 포션’을 마시지 않을 것이다.\n" +
                " \n" +
                "\n" +
                "물론, 그렇다고 이벨린이 반드시 임신한다고는 말할 순 없었지만...\n" +
                " \n" +
                "\n" +
                "지금까지 했던 어떤 섹스보다 압도적으로 임신 확률이 높다는 걸 이안은 알고 있었다.\n" +
                " \n" +
                "\n" +
                "“..이...이안!...흐엑!♥...옥...으우헷!!!♥멈쭈라곳!!♥...끄히익!♥..이...이고!♥..이,이상하다고오옷?!!♥”\n" +
                " \n" +
                "“...크윽!...이벨린!!”\n" +
                " \n" +
                "\n" +
                "그로 인해 사랑하는 암컷을 임신시킨다는 수컷의 가장 원초적인 본능이 이안의 뇌에서 아드레날린을 마구 뿜어내며 평상시보다 훨씬 빠르게 심장을 뛰게 했다.\n" +
                " \n" +
                "\n" +
                " \n" +
                "두근-! 두근-! 두근-!\n" +
                " \n" +
                "\n" +
                "터질 듯이 뛰는 심장은 전신의 혈액을 미친 듯이 공급했다.\n" +
                " \n" +
                "\n" +
                "그 결과, 지금 이안의 자지는 100%의 발기라는 한계를 돌파해서105%의 발기가 된 상황이었다.\n" +
                " \n" +
                "\n" +
                "“\u0601\u0601끄흐으으윽!!!♥♥....,이..이안...♥...호오윽!!♥...아.!...흐!!..흐아!!?♥”\n" +
                " \n" +
                "\n" +
                "여기서 한 가지 의문이 들 수도 있다.\n" +
                " \n" +
                "\n" +
                "지금의 이안이 105% 발기인 상태라면 100% 발기 자지에 맞춰져 있던 이벨린의 보지와 ‘완벽한 속궁합’이 깨진 것이 아닌가?\n" +
                " \n" +
                "\n" +
                "맞는 말이었다.\n" +
                " \n" +
                "\n" +
                "이벨린이 ‘이질감’을 느끼게 된 것도 ‘완벽한 속궁합’이 사라졌기 때문이니까.\n" +
                " \n" +
                "\n" +
                "“흐..흐...앗!♥!..아..끅..?!!♥!...제..쩨발!!..끄흑!♥..마..말쫌...뜨러봐!!♥”\n" +
                " \n" +
                "\n" +
                "수많은 억까를 지나서도 불굴, 단 한 번의 정실도 없이,단 한 번의 승리도 없이살아 온 이벨린이 마침내 빛을 본 것일까?\n" +
                " \n" +
                "\n" +
                "꾸우욱—!\n" +
                " \n" +
                "\n" +
                "“오..?...오옥?...끅!!..후기이이잇!?!♥♥”\n" +
                " \n" +
                "\n" +
                "더 이상 이안이 곁에서 떠나지 않는다는 확신에서 오는 안도감과 10년이 넘은 사랑의 결실을 오늘 볼 수 있다는 생각에 이벨린의 보지 역시 평소와는 아주 약간 변화하였다.\n" +
                " \n" +
                "\n" +
                "비율로 따지면5%정도.\n" +
                " \n" +
                "\n" +
                "덜컹-!\n" +
                " \n" +
                "\n" +
                "“..아윽..!..아..!♥...아..하...흐아...♥..이익!...호윽!...하...으에!!..오오옷!♥♥”\n" +
                " \n" +
                "\n" +
                "그러니 이건 기적이라 불러야 할 것이다.\n" +
                " \n" +
                "\n" +
                "5% 변화한 이벨린의 보지 모양이 이안의 105% 발기 자지와 맞물려 ‘조금 더 완벽한 속궁합’을 가지게 됐으니까.\n" +
                " \n" +
                "\n" +
                "‘...하윽!♥...오옥!♥...흐!!♥...어...이..이런거♥...모..몰랏!!?!♥’\n" +
                " \n" +
                "\n" +
                "추가로 한 가지 이벨린에게 긍정적인 사실은 방금 막 변화한 보지이기에 아직 이안의 자지가 약점에 닿은 적이 없다는 것이고...\n" +
                " \n" +
                "\n" +
                "“....끄히이익?!!♥♥♥”\n" +
                " \n" +
                "\n" +
                "푸욱-!\n" +
                " \n" +
                "\n" +
                "반대로 한 가지 부정적인 사실은 지금 이안의 105% 자지가 변화한 보지의 약점을 찔렀다는 것이다.\n" +
                " \n" +
                "\n" +
                "—딸각\n" +
                " \n" +
                "\n" +
                "‘아...?♥’\n" +
                " \n" +
                "\n" +
                "이벨린은 어디선가 퍼즐 조각이 맞춰지는 소리를 들은 것만 같았다.\n" +
                " \n" +
                "\n" +
                "그리고 이해했다.\n" +
                " \n" +
                "\n" +
                "이건 마치 새끼발가락을 옷장에 박은 다음 고통이 찾아오기 전에 주어지는 잠깐의 유예처럼 쾌락에 대비하라는 뜻이라는 걸.\n" +
                " \n" +
                "\n" +
                "두근—!! 두근—!! 두근—!!\n" +
                " \n" +
                "\n" +
                "‘어,어떻게!! ...내가...어떻게...해야하는데!!♥♥’\n" +
                " \n" +
                "\n" +
                " \n" +
                "지금은 아무것도 느낄 수 없었지만, 본능이 소리쳤다.\n" +
                " \n" +
                "\n" +
                "이제 곧 단 한 번도 경험한 적 없는 수준의 쾌락이 올 것이라고.\n" +
                " \n" +
                "\n" +
                " \n" +
                "푸슉-! 푸슈육-!!\n" +
                " \n" +
                "\n" +
                "“아..아아!!..오..온다아아앗?!!.....끄히이잇!!!♥♥...끅..!?!오윽!!♥...오오옥!♥”\n" +
                " \n" +
                "\n" +
                "차라리 비명에 가까운 신음이었다.\n" +
                " \n" +
                "\n" +
                "이벨린은 감전이라도 된 것처럼 허리가 멋대로 쳐올리며 조수를 뿜기 시작했다.\n" +
                " \n" +
                "\n" +
                "“끄흐아앗!♥아...으아.!!.♥아..!♥흐아아오옷!!♥..아...흐아♥....이...이안♥...이거..이..상해♥..에엣!!히이익!...♥”\n" +
                " \n" +
                "\n" +
                "쾌감도 이 정도 수준이 되니 공포가 되었다.\n" +
                " \n" +
                "\n" +
                "지글─ 지글─\n" +
                " \n" +
                "\n" +
                " \n" +
                "지금까지 이안과의 섹스를 할 때 뇌가 쾌락에 튀겨지는 기분을 느꼈다면, 이건 쾌락이란 이름의 끓는 기름 속에 몸을 던진 것만 같았다.\n" +
                " \n" +
                "\n" +
                "“\u0601\u0601\u0601\u0601\u0601\u0601\u0601᧗⟆?!!♥♥♥”\n" +
                " \n" +
                "\n" +
                "자궁에서 올라온 쾌락이 전신으로 퍼져나가서 이벨린의 몸 전체가 마치 성감대가 된 것처럼 한없이 민감해졌다.\n" +
                " \n" +
                "\n" +
                "‘끅..!..♥이...이안!!♥...이안...이안!!♥도...도와쪄♥!..이안..!!♥’\n" +
                " \n" +
                "\n" +
                "아이러니하게도 이 쾌락을 준 건 이안이었지만, 이벨린이 가장 의지할 수 있는 사람도 이안이었다.\n" +
                " \n" +
                "\n" +
                "“끄흑..♥...하..이안!♥..아..안대..보..보지♥...저..절정이..아..안멈..쪄!!♥..끄히이익!!..무...무서웟!!♥도..도...도아쪄!!..끅!!!♥...오?...오으윽??!!♥...끅..!!..끄힉!?♥..하..하으..하..!♥!...이..이안...소..손..잡아줘.♥.끅...손!..빠..리잇!!♥♥”\n" +
                " \n" +
                "\n" +
                "완벽을 뛰어넘은 쾌락에 이벨린이 겁먹은 채 손을 내밀며 말했다.\n" +
                " \n" +
                "\n" +
                " \n" +
                "스윽─\n" +
                " \n" +
                "\n" +
                "그러자 이안은 마치 9년 전 이벨린을 껴안으며 떨어졌을 때처럼 부드럽게 안으며 속삭였다.\n" +
                " \n" +
                "\n" +
                "“하...♥아..흐아악♥...이..아안...지..지금..♥.움직이면..아..안대♥...끄히이기!!♥”\n" +
                " \n" +
                "“괜찮아. 이벨린. 나 여기 있어.”\n" +
                " \n" +
                "“...흐아...♥으...흐아♥...이...이안...아..!!...끄흑..하으윽!!”♥\n" +
                " \n" +
                "“응, 이벨린.”\n" +
                " \n" +
                "“하,하윽♥..끅..!!♥..사...사랑...하..한다고...해져♥...끅..나..사랑한다꼬..♥히끅!!.♥.말해쬬...♥”\n" +
                " \n" +
                "\n" +
                "이안은 이벨린의 손에 깍지를 끼며 천천히 몸을 돌려 눈을 마주 보게 만들었다.\n" +
                " \n" +
                "\n" +
                "“사랑해 이벨린.”\n" +
                " \n" +
                "\n" +
                "펑-!\n" +
                " \n" +
                "\n" +
                " \n" +
                "아아...\n" +
                " \n" +
                "\n" +
                " \n" +
                "도대체 나는 이안을 얼마나 사랑하는 걸까?\n" +
                " \n" +
                "\n" +
                "이안의 입에서 나온 사랑한다는 말은 한순간이지만 이벨린의 전신을 점거하던 쾌락을 몰아낼 정도로 강렬했다.\n" +
                " \n" +
                "\n" +
                "“끅..♥흐아..으,응!!♥...나듀..끄흑..사량해...!!.♥.이..이안...사..사량해..!!♥”\n" +
                " \n" +
                "\n" +
                "말이 끝나는 것과 동시에 누가 먼저라고 할 것도 없이 서로에게 달려들어 입을 맞췄다.\n" +
                " \n" +
                "\n" +
                "“흐읍..♥...흐읍....♥쫍..흐브..!!♥..하..흐읍..!..♥흡!..♥”\n" +
                " \n" +
                "\n" +
                "이벨린과 이안이 혓바닥을 서로 뒤섞으며 타액을 교환하고 숨을 쉬기 위해서 아주 잠깐 떨어졌다가 그 시간조차 아깝다는 듯 다시 달려든다.\n" +
                " \n" +
                "\n" +
                "“하아...!!♥하아..!!♥.사량해...사량해...사랑해...이안..너무..사량해..!!♥끄흑...!!”\n" +
                " \n" +
                "“나도 사랑해. 이벨린.”\n" +
                " \n" +
                "\n" +
                "몇 번이고 키스하며 사랑을 고백하며 시간이 얼마나 지났을까?\n" +
                " \n" +
                "\n" +
                "마침내 이벨린의 떨림이 멈췄다.\n" +
                " \n" +
                "“이벨린, 좀 진정됐어?”\n" +
                " \n" +
                "“하아...하아...♥이...이안...”\n" +
                " \n" +
                "\n" +
                "물론, 보지 속에 잠들어 있는 105%의 자지는 여전히 이벨린을 노리고 있었지만, 이안과 이렇게 마주 보고 손을 잡으니 더는 무섭지 않았다.\n" +
                " \n" +
                "\n" +
                "“미안, 이렇게 반응 할 줄은 몰라서... 힘들면 이제 그만할까?”\n" +
                " \n" +
                "“...시..싫어!...계...계속...할래.”\n" +
                " \n" +
                "\n" +
                "아니...\n" +
                " \n" +
                "\n" +
                "솔직히 무섭기는 했지만 지금 멈추고 싶지는 않았다.\n" +
                " \n" +
                "\n" +
                "자그마치 10년이다.\n" +
                " \n" +
                "\n" +
                "10년 만에 이안 저 새끼가 나를 임신시킬 결심을 했는데 지금 멈췄다가 기회를 놓치면 평생 후회할 것 같았다.\n" +
                " \n" +
                "\n" +
                "“정말? 계속해도 되겠어?”\n" +
                " \n" +
                "“으,응...하..흐윽!...대...대신...처..천히..끅!!...지..진짜...천천히...해줘...”\n" +
                " \n" +
                "“알았어. 약속 할게.”\n" +
                " \n" +
                "“지...진짜야?...야..약속한거야?...아니면...화낼거니까...그,그럼..일단...나..이거...너무...기분...좋아서...무..무서우니까...내..내가..됐다고..하면..움직여..후우!...후우...!”\n" +
                " \n" +
                "\n" +
                "이벨린이 긴 심호흡을 할 때마다 달콤한 벌꿀내음이 이안의 코끝을 스쳤다.\n" +
                " \n" +
                "\n" +
                "“....하..하아..후....이...이제..괘...괜찮아 움직여도.”\n" +
                " \n" +
                "“응, 움직일게.”\n" +
                " \n" +
                "\n" +
                "쯔즉- 찌즈윽-\n" +
                " \n" +
                "YW9peUx5cktZYXhyU2hzY1VsMkQ0ZUl6aldwMGNXN2JzY05naHk5c1JQVWM3eXZQbG5xWUZUQ3dHaVRyNlRVMg \n" +
                "\n" +
                "“오윽흑...!♥...으아..♥끄흑....♥하아악!♥...이..이안..!♥”\n" +
                " \n" +
                "\n" +
                "솔직히 이안이 약속을 어기고 허리를 제멋대로 흔들까 봐 걱정했지만 기우였다.\n" +
                " \n" +
                "\n" +
                "이안은 약속했던 대로 최대한 움직임을 억제한 채 조금씩 자지를 움직였다.\n" +
                " \n" +
                "\n" +
                "쯔윽─ 쯔윽─\n" +
                " \n" +
                "\n" +
                "그래서 이벨린은 이 상황이 더 이상하게 느껴졌다.\n" +
                " \n" +
                "\n" +
                "그동안 이안과 했던 폭력적인 섹스와 비교하면 지금 이건 소꿉장난과도 다름없어야 하는데...\n" +
                " \n" +
                "\n" +
                "‘아...!!♥흐아...!끄흑..!♥하...!!♥’\n" +
                " \n" +
                "\n" +
                "이안이 한 번 움직일 때다 자궁을 중심으로 쾌락이 터질 듯이 끓어올랐으니까.\n" +
                " \n" +
                "\n" +
                "“끄흣!♥...샤...사량해♥...이안...사랑해..♥”\n" +
                " \n" +
                "“나도 사랑해 이벨린.”\n" +
                " \n" +
                "“응...!응!♥..끄흑...♥이안...이안...♥너는..후욱...내..이안...이얏!♥..히윽!♥...계..계속..말해줘..사랑..한다고..♥”\n" +
                " \n" +
                "“응, 이벨린 난 이벨린의 남자야. 사랑해.”\n" +
                " \n" +
                "“하...!♥하윽..!♥오읏!♥..이...이안...♥”\n" +
                " \n" +
                "\n" +
                "천천히 움직이는 만큼 이벨린은 자지의 형태를 똑똑히 느끼고 있었다.\n" +
                " \n" +
                "\n" +
                "움찔움찔!\n" +
                " \n" +
                "\n" +
                "‘아..아!♥...흐끄흑!!♥...펴..평소..보다♥...이..이안꺼♥...커..져이써...♥’\n" +
                " \n" +
                "\n" +
                "이제는 확실히 느껴졌다.\n" +
                " \n" +
                "\n" +
                "지금 이안의 자지는 평소보다 크게 발기해있었다.\n" +
                " \n" +
                "\n" +
                "이벨린에겐 그것이 참을 수 없게 기뻤다.\n" +
                " \n" +
                "\n" +
                "그야, 이렇게 느긋하게 움직이는 섹스임에도 이안은 지금까지 했던 어떤 섹스보다 흥분하고 있다는 뜻이었으니까.\n" +
                " \n" +
                "\n" +
                "‘..하...!.♥아!!♥...나..나를..저렇게...♥아,임신...♥끄흑!..시키고...싶어서...♥’\n" +
                " \n" +
                "\n" +
                "움찔— 움찔—\n" +
                " \n" +
                "\n" +
                "“이벨린. 나 슬슬...”\n" +
                " \n" +
                "“응,으응..!끄흑!..괘..괜찮앗...!...♥”\n" +
                " \n" +
                "\n" +
                "이안의 사정이 가까워졌다는 건 말하지 않아도 느낄 수 있었다.\n" +
                " \n" +
                "\n" +
                "“하아..♥하아..♥끅!!..싸..싸졋!♥...이대로..자...자궁안에♥...잔뜩...싸져!!♥...나...나...!!이..임신..시켜줘..!!♥”\n" +
                " \n" +
                "\n" +
                " \n" +
                "꽈아악-!\n" +
                " \n" +
                "\n" +
                "동시에 이벨린의 다리가 이안의 허리를 휘감으며 정액이 조금이라도 더 깊게 들어오게 만들었고...\n" +
                " \n" +
                "\n" +
                "-울컥! -울컥!\n" +
                " \n" +
                "\n" +
                " \n" +
                "“\u0601\u0601\u0601\u0601\u0601\u0601᧗⟆?!??!♥♥♥”\n" +
                " \n" +
                "\n" +
                "\n" +
                "쾌감의 폭풍 속에서 의식이 점차 희미해져 가는 중에 이벨린은 이안을 향해 환하게 웃으며 속삭였다.\n" +
                " \n" +
                "\n" +
                "“임신...하면...좋겠네...♥”\n" +
                " \n" +
                "<img src=\"//images.novelpia.com/imagebox/96/969b35f5d57a89ea24e269832cef85d6_1214338_1733303798_ori.file\">";
        Result r = process(src);
        System.out.println("=== 去空行、去<img>后的文本 ===");
        System.out.print(r.textNoImg);
        System.out.println("=== img标签与位置对应 ===");
        r.imgWithPos.forEach((img, pos) -> System.out.println(img + "  ->  " + pos));
    }
}